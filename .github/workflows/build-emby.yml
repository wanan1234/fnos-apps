name: Build Emby fnOS Package

on:
  push:
    paths:
      - 'apps/emby/**'
      - 'shared/**'
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
      revision:
        description: 'Revision number'
        required: false

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      revision: ${{ steps.version.outputs.revision }}
      should_build: ${{ steps.version.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: Get latest Emby version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            REVISION="${{ github.event.inputs.revision }}"
          else
            VERSION=$(curl -s https://api.github.com/repos/MediaBrowser/Emby.Releases/releases | jq -r '.[0].tag_name' | sed 's/^v//')
            REVISION=""
          fi

          TAG_PREFIX="emby/v${VERSION}"
          EXISTING_TAG=$(git tag -l "${TAG_PREFIX}*" | sort -V | tail -1)

          if [ -z "$EXISTING_TAG" ]; then
            FINAL_TAG="${TAG_PREFIX}"
            SHOULD_BUILD="true"
          else
            REVISION_NUM=$(echo "$EXISTING_TAG" | grep -oP '(?<=-r)\d+$' || echo "0")
            NEW_REVISION=$((REVISION_NUM + 1))
            FINAL_TAG="${TAG_PREFIX}-r${NEW_REVISION}"
            SHOULD_BUILD="true"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "revision=${FINAL_TAG}" >> $GITHUB_OUTPUT
          echo "should_build=${SHOULD_BUILD}" >> $GITHUB_OUTPUT

  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86
            deb_arch: amd64
            manifest_platform: x86
          - arch: arm
            deb_arch: arm64
            manifest_platform: arm
    steps:
      - uses: actions/checkout@v4

      - name: Download Emby
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          wget -O emby.deb "https://github.com/MediaBrowser/Emby.Releases/releases/download/${VERSION}/emby-server-deb_${VERSION}_${{ matrix.deb_arch }}.deb"

      - name: Extract Emby
        run: |
          mkdir -p emby_extracted
          dpkg-deb -x emby.deb emby_extracted

      - name: Build app_root
        run: |
          mkdir -p app_root/opt/emby-server
          cp -r emby_extracted/opt/emby-server/* app_root/opt/emby-server/
          mkdir -p app_root/bin
          cp apps/emby/fnos/bin/emby-server app_root/bin/
          cp apps/emby/fnos/EmbyServer.sc app_root/
          mkdir -p app_root/config
          cp -r apps/emby/fnos/config/* app_root/config/
          mkdir -p app_root/ui
          cp -r apps/emby/fnos/ui/* app_root/ui/

      - name: Create app.tgz
        run: |
          tar -czf app.tgz -C app_root .

      - name: Build FPK
        run: |
          ./scripts/build-fpk.sh apps/emby app.tgz "${{ needs.check-version.outputs.version }}" "${{ matrix.manifest_platform }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: emby-fpk-${{ matrix.arch }}
          path: emby_*.fpk

  release:
    needs: [check-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TAG="${{ needs.check-version.outputs.revision }}"

          RELEASE_NOTES="Emby fnOS Package v${VERSION}

          Mirror links:
          - x86: https://ghfast.top/https://github.com/conversun/fnos-apps/releases/download/${TAG}/emby_${VERSION}_x86.fpk
          - ARM: https://ghfast.top/https://github.com/conversun/fnos-apps/releases/download/${TAG}/emby_${VERSION}_arm.fpk"

          gh release create "$TAG" \
            --title "Emby v${VERSION}" \
            --notes "$RELEASE_NOTES" \
            artifacts/emby-fpk-x86/*.fpk \
            artifacts/emby-fpk-arm/*.fpk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
