name: Reusable fnOS App Build

on:
  workflow_call:
    inputs:
      app:
        description: 'App slug: plex|emby|qbittorrent|nginx|jellyfin|ani-rss|gopeed'
        required: true
        type: string
      version:
        description: 'Override version (empty for latest)'
        required: false
        type: string
        default: ''
      revision:
        description: 'Revision suffix, e.g. r2'
        required: false
        type: string
        default: ''
      event_name:
        description: 'Original trigger event name'
        required: false
        type: string
        default: 'workflow_dispatch'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      full_version: ${{ steps.version.outputs.full_version }}
      upstream_tag: ${{ steps.version.outputs.upstream_tag }}
      release_tag: ${{ steps.check.outputs.release_tag }}
      should_build: ${{ steps.check.outputs.should_build }}
      fpk_version: ${{ steps.check.outputs.fpk_version }}
      file_prefix: ${{ steps.meta.outputs.file_prefix }}
      release_title: ${{ steps.meta.outputs.release_title }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate App Input
        run: |
          APP="${{ inputs.app }}"
          VALID_APPS="plex emby qbittorrent nginx jellyfin ani-rss gopeed audiobookshelf fnos-apps-store"
          if ! echo "$VALID_APPS" | grep -qw "$APP"; then
            echo "Invalid app: $APP. Must be one of: $VALID_APPS" >&2
            exit 1
          fi

      - name: Resolve App Metadata
        id: meta
        run: |
          APP="${{ inputs.app }}"
          source "scripts/apps/${APP}/meta.env"
          echo "file_prefix=${FILE_PREFIX}" >> "$GITHUB_OUTPUT"
          echo "release_title=${RELEASE_TITLE}" >> "$GITHUB_OUTPUT"

      - name: Get Latest Version
        id: version
        run: |
          APP="${{ inputs.app }}"
          INPUT_VERSION="${{ inputs.version }}"
          bash "scripts/apps/${APP}/get-latest-version.sh" "${INPUT_VERSION}"

      - name: Check Release and Determine Tag
        id: check
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REVISION="${{ inputs.revision }}"
          APP="${{ inputs.app }}"
          EVENT_NAME="${{ inputs.event_name }}"
          bash scripts/ci/resolve-release-tag.sh "$APP" "$VERSION" "$EVENT_NAME" "$REVISION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch: [x86, arm]
        include:
          - arch: x86
            manifest_platform: x86
            deb_arch: amd64
            plex_build: linux-x86_64
            qb_binary_prefix: x86_64
            tarball_arch: amd64
            jre_arch: x64
          - arch: arm
            manifest_platform: arm
            deb_arch: arm64
            plex_build: linux-aarch64
            qb_binary_prefix: aarch64
            tarball_arch: arm64
            jre_arch: aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Package
        run: |
          APP="${{ inputs.app }}"
          VERSION="${{ needs.check-version.outputs.version }}"
          FPK_VERSION="${{ needs.check-version.outputs.fpk_version }}"
          MANIFEST_PLATFORM="${{ matrix.manifest_platform }}"
          FILE_PREFIX="${{ needs.check-version.outputs.file_prefix }}"

          bash "scripts/apps/${APP}/build.sh"

          ls -lh app.tgz
          bash scripts/build-fpk.sh "apps/${APP}" app.tgz "${VERSION}" "${MANIFEST_PLATFORM}"
          FPK_BUILT="${FILE_PREFIX}_${VERSION}_${MANIFEST_PLATFORM}.fpk"
          FPK_FINAL="${FILE_PREFIX}_${FPK_VERSION}_${MANIFEST_PLATFORM}.fpk"
          if [ "$FPK_BUILT" != "$FPK_FINAL" ]; then
            mv "$FPK_BUILT" "$FPK_FINAL"
          fi
          echo "Built: ${FPK_FINAL}"
          ls -lh "${FPK_FINAL}"
        env:
          VERSION: ${{ needs.check-version.outputs.version }}
          FULL_VERSION: ${{ needs.check-version.outputs.full_version }}
          UPSTREAM_TAG: ${{ needs.check-version.outputs.upstream_tag }}
          DEB_ARCH: ${{ matrix.deb_arch }}
          PLEX_BUILD: ${{ matrix.plex_build }}
          QB_BINARY_PREFIX: ${{ matrix.qb_binary_prefix }}
          TARBALL_ARCH: ${{ matrix.tarball_arch }}
          JRE_ARCH: ${{ matrix.jre_arch }}
          CODENAME: bookworm

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk-${{ matrix.arch }}
          path: ${{ needs.check-version.outputs.file_prefix }}_${{ needs.check-version.outputs.fpk_version }}_${{ matrix.manifest_platform }}.fpk
          retention-days: 1

  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        run: |
          APP="${{ inputs.app }}"
          VERSION="${{ needs.check-version.outputs.version }}"
          FPK_VERSION="${{ needs.check-version.outputs.fpk_version }}"
          FULL_VERSION="${{ needs.check-version.outputs.full_version }}"
          UPSTREAM_TAG="${{ needs.check-version.outputs.upstream_tag }}"
          RELEASE_TAG="${{ needs.check-version.outputs.release_tag }}"
          TITLE_PREFIX="${{ needs.check-version.outputs.release_title }}"
          FILE_PREFIX="${{ needs.check-version.outputs.file_prefix }}"

          if [[ "$RELEASE_TAG" != "$APP/v$VERSION" ]]; then
            REVISION_NOTE="
          - **打包修订**: ${RELEASE_TAG##*-}
          - ⚠️ 如果当前版本使用正常，无需更新此修订版。需先卸载再重新安装。"
          else
            REVISION_NOTE=""
          fi

          CHANGELOG=""
          CHANGELOG_FILE="apps/${APP}/CHANGELOG.md"
          if [ -f "$CHANGELOG_FILE" ]; then
            CHANGELOG=$(awk '/^## /{if(found) exit; found=1; next} found' "$CHANGELOG_FILE")
          fi

          export VERSION FPK_VERSION FULL_VERSION UPSTREAM_TAG RELEASE_TAG FILE_PREFIX REVISION_NOTE CHANGELOG
          NOTES=$(envsubst < "scripts/apps/${APP}/release-notes.tpl")

          gh release create "$RELEASE_TAG" \
            --title "${TITLE_PREFIX} ${VERSION} for fnOS" \
            --notes "$NOTES" \
            artifacts/fpk-x86/*.fpk \
            artifacts/fpk-arm/*.fpk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
