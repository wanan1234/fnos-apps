#!/bin/sh
APP_DIR="${TRIM_APPDEST}"
APP_DATA_DIR=$1
DATA_DIR="$APP_DATA_DIR/data"
CONFIG_FILE="$APP_DATA_DIR/config.yml"

mkdir -p "$DATA_DIR"

# 首次运行时生成默认配置文件
if [ ! -f "$CONFIG_FILE" ]; then
    cat > "$CONFIG_FILE" <<EOF
# Gotify 配置文件
# 完整配置项参考: https://gotify.net/docs/config

server:
  port: ${TRIM_SERVICE_PORT}

database:
  dialect: sqlite3
  connection: data/gotify.db

defaultuser:
  name: admin
  pass: admin

uploadedimagesdir: data/images
pluginsdir: data/plugins
registration: false
EOF
fi

cd "$APP_DATA_DIR" || exit 1

ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')
exec "$APP_DIR/gotify-linux-${ARCH}"
