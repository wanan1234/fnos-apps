#!/bin/bash
# tinyMediaManager Docker app â€” wizard integration

service_postinst() {
    local env_file="${TRIM_APPDEST}/docker/.env"
    local has_env=false

    if [ -n "${wizard_movie_dir}" ]; then
        echo "MOVIE_DIR=${wizard_movie_dir}" > "$env_file"
        mkdir -p "${wizard_movie_dir}" 2>/dev/null || true
        install_log "Wrote docker .env: MOVIE_DIR=${wizard_movie_dir}"
        has_env=true
    fi

    if [ -n "${wizard_tvshow_dir}" ]; then
        if [ "$has_env" = true ]; then
            echo "TVSHOW_DIR=${wizard_tvshow_dir}" >> "$env_file"
        else
            echo "TVSHOW_DIR=${wizard_tvshow_dir}" > "$env_file"
        fi
        mkdir -p "${wizard_tvshow_dir}" 2>/dev/null || true
        install_log "Wrote docker .env: TVSHOW_DIR=${wizard_tvshow_dir}"
    fi

    mkdir -p "${TRIM_PKGVAR}/config" "${TRIM_PKGVAR}/data/movies" "${TRIM_PKGVAR}/data/tvshows" 2>/dev/null || true
    chown -R "${TRIM_UID}:${TRIM_GID}" "${TRIM_PKGVAR}/config" "${TRIM_PKGVAR}/data" 2>/dev/null || true
}

service_preupgrade() {
    if [ -f "${TRIM_APPDEST}/docker/.env" ]; then
        cp "${TRIM_APPDEST}/docker/.env" "${TRIM_PKGVAR}/.env.bak"
    fi
}

service_restore() {
    if [ -f "${TRIM_PKGVAR}/.env.bak" ]; then
        cp "${TRIM_PKGVAR}/.env.bak" "${TRIM_APPDEST}/docker/.env"
        rm -f "${TRIM_PKGVAR}/.env.bak"
    fi
}
